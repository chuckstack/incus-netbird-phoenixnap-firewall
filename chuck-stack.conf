# Define the custom table
table inet chuck-stack {
    # Define a chain to handle traffic coming into the server via NF_INET_PRE_ROUTING
    chain input {
        type filter hook input priority filter; policy drop;

        # Allow traffic on the loopback interface
        iifname "lo" accept

        # Allow related and established sessions
        ct state related,established accept

        # Allow traffic from the Netbird interface (e.g., wt0)
        iifname "wt0" accept

        # Allow traffic from Incus bridge
        iifname "incusbr0" accept

        # Allow DHCP/DNS services
        udp dport { 53, 67, 547 } accept
        tcp dport 53 accept

        # Allow ICMPv4/ICMPv6 for network diagnostics and IPv6 functionality
        icmp type { destination-unreachable, time-exceeded, parameter-problem } accept
        icmpv6 type { destination-unreachable, packet-too-big, time-exceeded, parameter-problem,
                      nd-router-solicit, nd-router-advert, nd-neighbor-solicit, nd-neighbor-advert,
                      mld2-listener-report } accept
    }

    # Define a chain to manage forwarding traffic
    chain forward {
        type filter hook forward priority filter; policy drop;

        # Allow forwarding traffic that is related or established
        ct state related,established accept

        # Allow traffic from or to the Netbird interface
        iifname "wt0" accept
        oifname "wt0" accept

        # Allow traffic to/from Incus bridge
        iifname "incusbr0" accept
        oifname "incusbr0" accept
    }

    # Define a chain to handle outgoing traffic
    chain output {
        type filter hook output priority filter; policy accept;

        # Generally allow outgoing traffic
        # Allow DHCP/DNS responses
        udp sport { 53, 67, 547 } accept
        tcp sport 53 accept
    }
}

# Add any additional custom rules below as needed
# to add: sudo nft -f chuck-stack.conf
# to drop: sudo nft delete table inet chuck-stack
